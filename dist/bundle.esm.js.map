{"version":3,"file":"bundle.esm.js","sources":["../src/index.js"],"sourcesContent":["import { isString, isFunction } from 'lodash';\nimport EventEmitter from 'events';\nimport Promise from 'bluebird';\n\nconst symbolLift = Symbol('_lift');\nconst SymbolCheckMiddleware = Symbol('_checkMiddleware');\n\nprocess.on('uncaughtException', (err) => {\n  // eslint-disable-next-line no-console\n  console.error('uncaughtException:', err);\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', (reason, p) => {\n  // eslint-disable-next-line no-console\n  console.log('Unhandled Rejection at:', p, 'reason:', reason);\n  process.exit(1);\n});\n\nclass Ofa2 extends EventEmitter {\n  constructor(projectPath, options) {\n    super();\n\n    this.options = options || {};\n    this.middlewares = [];\n\n    if (!projectPath) {\n      throw new Error('need projectPath param');\n    }\n    this.projectPath = projectPath;\n\n    this.init();\n  }\n\n  init() {\n    this.environment = (process.env.NODE_ENV || 'development').trim();\n    this.promise = Promise.resolve();\n\n    this.config = {};\n    this.model = {};\n    this.global = {};\n\n    this.graphql = {};\n\n    // 设置 alias\n    if (this.options.alias) {\n      global[this.options.alias] = this;\n    }\n    else {\n      global.framework = this;\n    }\n\n    global.logger = console;\n    global.logger.trace = global.logger.log;\n    global.logger.debug = global.logger.log;\n  }\n\n  use(middlewareName) {\n    let middleware;\n    if (isFunction(middlewareName)) {\n      middleware = middlewareName;\n    }\n    else if (isString(middlewareName)) {\n      // TODO: 等待 import 支持 动态导入后取出 require;\n      try {\n        /* eslint-disable global-require */\n        /* eslint-disable import/no-dynamic-require */\n        middleware = require(`ofa2-${middlewareName}`);\n      }\n      catch (e) {\n        // eslint-disable-next-line no-console\n        console.warn(e);\n        process.exit(1);\n      }\n    }\n    else {\n      throw new Error('middleware should be string or function');\n    }\n\n    this.middlewares.push(middleware.default ? middleware.default : middleware);\n    return this;\n  }\n\n  async [SymbolCheckMiddleware](name) {\n    await Promise.each(this.middlewares, (middleware) => {\n      if (isFunction(middleware[name])) {\n        return middleware[name].call(this);\n      }\n      return undefined;\n    });\n\n    this.emit(`${name}ed`);\n  }\n\n  async [symbolLift]() {\n    await Promise.each(this.middlewares, (middleware) => {\n      if (isFunction(middleware)) {\n        return middleware.call(this);\n      }\n      if (isFunction(middleware.lift)) {\n        return middleware.lift.call(this);\n      }\n      return undefined;\n    });\n\n    this.emit('lifted');\n  }\n\n  lift() {\n    this.promise = this.promise.then(() => {\n      this[symbolLift]();\n    });\n    return this;\n  }\n\n  listen() {\n    this.promise = this.promise.then(() => {\n      return this[SymbolCheckMiddleware]('listen');\n    });\n    return this;\n  }\n\n  lower() {\n    this.promise = this.promise.then(() => {\n      return this[SymbolCheckMiddleware]('lower');\n    });\n    return this;\n  }\n}\n\nexport default Ofa2;\n"],"names":["symbolLift","Symbol","SymbolCheckMiddleware","process","on","err","error","exit","reason","p","log","Ofa2","EventEmitter","projectPath","options","middlewares","Error","init","environment","env","NODE_ENV","trim","promise","Promise","resolve","config","model","global","graphql","this","alias","framework","logger","console","trace","debug","middlewareName","middleware","isFunction","isString","require","e","warn","push","default","name","each","call","emit","lift","then"],"mappings":"uGAIA,MAAMA,WAAaC,OAAO,SACpBC,sBAAwBD,OAAO,oBAErCE,QAAQC,GAAG,oBAAsBC,YAEvBC,MAAM,qBAAsBD,WAC5BE,KAAK,KAGfJ,QAAQC,GAAG,qBAAsB,CAACI,EAAQC,aAEhCC,IAAI,0BAA2BD,EAAG,UAAWD,WAC7CD,KAAK,WAGTI,aAAaC,yBACLC,EAAaC,mBAGlBA,QAAUA,WACVC,gBAEAF,QACG,IAAIG,MAAM,+BAEbH,YAAcA,OAEdI,mBAIAC,aAAef,QAAQgB,IAAIC,UAAY,eAAeC,YACtDC,QAAUC,QAAQC,eAElBC,eACAC,cACAC,eAEAC,WAGDC,KAAKf,QAAQgB,aACRD,KAAKf,QAAQgB,OAASD,YAGtBE,UAAYF,YAGdG,OAASC,eACTD,OAAOE,MAAQP,OAAOK,OAAOtB,WAC7BsB,OAAOG,MAAQR,OAAOK,OAAOtB,QAGlC0B,OACEC,KACAC,WAAWF,KACAA,MAEV,CAAA,IAAIG,SAASH,SAcV,IAAIpB,MAAM,iDATDwB,gBAAgBJ,KAE/B,MAAOK,WAEGC,KAAKD,WACLlC,KAAK,gBAOZQ,YAAY4B,KAAKN,EAAWO,QAAUP,EAAWO,QAAUP,GACzDR,WAGF3B,uBAAuB2C,SACtBtB,QAAQuB,KAAKjB,KAAKd,YAAcsB,OAChCC,WAAWD,EAAWQ,WACjBR,EAAWQ,GAAME,KAAKlB,aAK5BmB,QAAQH,aAGR7C,oBACCuB,QAAQuB,KAAKjB,KAAKd,YAAcsB,GAChCC,WAAWD,GACNA,EAAWU,KAAKlB,MAErBS,WAAWD,EAAWY,MACjBZ,EAAWY,KAAKF,KAAKlB,mBAK3BmB,KAAK,6BAIL1B,QAAUO,KAAKP,QAAQ4B,KAAK,UAC1BlD,gBAEA6B,0BAIFP,QAAUO,KAAKP,QAAQ4B,KAAK,IACxBrB,KAAK3B,uBAAuB,WAE9B2B,yBAIFP,QAAUO,KAAKP,QAAQ4B,KAAK,IACxBrB,KAAK3B,uBAAuB,UAE9B2B"}
{"version":3,"file":"bundle.esm.js","sources":["../src/index.js"],"sourcesContent":["import { isString, isFunction } from 'lodash';\nimport EventEmitter from 'events';\nimport { resolve as pathResolve } from 'path';\nimport Promise from 'bluebird';\n\nconst symbolLift = Symbol('_lift');\nconst SymbolCheckMiddleware = Symbol('_checkMiddleware');\n\nprocess.on('uncaughtException', (err) => {\n  // eslint-disable-next-line no-console\n  console.error('uncaughtException:', err);\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', (reason, p) => {\n  // eslint-disable-next-line no-console\n  console.log('Unhandled Rejection at:', p, 'reason:', reason);\n  process.exit(1);\n});\n\nclass Ofa2 extends EventEmitter {\n  constructor(projectPath, options) {\n    super();\n\n    this.options = options || {};\n    this.middlewares = [];\n\n    if (!projectPath) {\n      throw new Error('need projectPath param');\n    }\n    this.projectPath = projectPath;\n\n    this.init();\n  }\n\n  init() {\n    this.environment = (process.env.NODE_ENV || 'development').trim();\n    this.promise = Promise.resolve();\n\n    this.config = {};\n    this.model = {};\n    this.global = {};\n\n    this.graphql = {};\n\n    // 设置 alias\n    if (this.options.alias) {\n      global[this.options.alias] = this;\n    }\n    else {\n      global.framework = this;\n    }\n\n    global.logger = console;\n    global.logger.trace = global.logger.log;\n    global.logger.debug = global.logger.log;\n  }\n\n  use(middlewareName) {\n    let middleware;\n    if (isFunction(middlewareName)) {\n      middleware = middlewareName;\n    }\n    else if (isString(middlewareName)) {\n      // TODO: 等待 import 支持 动态导入后取出 require;\n      try {\n        /* eslint-disable global-require */\n        /* eslint-disable import/no-dynamic-require */\n        middleware = require(pathResolve(\n          this.projectPath,\n          `../node_modules/ofa2-${middlewareName}`\n        ));\n      }\n      catch (e) {\n        // eslint-disable-next-line no-console\n        console.warn(e);\n        process.exit(1);\n      }\n    }\n    else {\n      throw new Error('middleware should be string or function');\n    }\n\n    this.middlewares.push(middleware.default ? middleware.default : middleware);\n    return this;\n  }\n\n  async [SymbolCheckMiddleware](name) {\n    await Promise.each(this.middlewares, (middleware) => {\n      if (isFunction(middleware[name])) {\n        return middleware[name].call(this);\n      }\n      return undefined;\n    });\n\n    this.emit(`${name}ed`);\n  }\n\n  async [symbolLift]() {\n    await Promise.each(this.middlewares, (middleware) => {\n      if (isFunction(middleware)) {\n        return middleware.call(this);\n      }\n      if (isFunction(middleware.lift)) {\n        return middleware.lift.call(this);\n      }\n      return undefined;\n    });\n\n    this.emit('lifted');\n  }\n\n  lift() {\n    this.promise = this.promise.then(() => {\n      this[symbolLift]();\n    });\n    return this;\n  }\n\n  listen() {\n    this.promise = this.promise.then(() => {\n      return this[SymbolCheckMiddleware]('listen');\n    });\n    return this;\n  }\n\n  lower() {\n    this.promise = this.promise.then(() => {\n      return this[SymbolCheckMiddleware]('lower');\n    });\n    return this;\n  }\n}\n\nexport default Ofa2;\n"],"names":["symbolLift","Symbol","SymbolCheckMiddleware","process","on","err","error","exit","reason","p","log","Ofa2","EventEmitter","projectPath","options","middlewares","Error","init","environment","env","NODE_ENV","trim","promise","Promise","resolve","config","model","global","graphql","alias","framework","logger","console","trace","debug","middlewareName","middleware","isFunction","isString","require","pathResolve","e","warn","push","default","name","each","call","undefined","emit","lift","then"],"mappings":"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"}
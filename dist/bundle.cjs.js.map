{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import { isString, isFunction } from 'lodash';\nimport EventEmitter from 'events';\nimport Promise from 'bluebird';\n\nconst symbolLift = Symbol('_lift');\nconst SymbolCheckMiddleware = Symbol('_checkMiddleware');\n\nprocess.on('uncaughtException', (err) => {\n  // eslint-disable-next-line no-console\n  console.error('uncaughtException:', err);\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', (reason, p) => {\n  // eslint-disable-next-line no-console\n  console.log('Unhandled Rejection at:', p, 'reason:', reason);\n  process.exit(1);\n});\n\nclass Ofa2 extends EventEmitter {\n  constructor(projectPath, options) {\n    super();\n\n    this.options = options || {};\n    this.middlewares = [];\n\n    if (!projectPath) {\n      throw new Error('need projectPath param');\n    }\n    this.projectPath = projectPath;\n\n    this.init();\n  }\n\n  init() {\n    this.environment = (process.env.NODE_ENV || 'development').trim();\n    this.promise = Promise.resolve();\n\n    this.config = {};\n    this.model = {};\n    this.global = {};\n\n    this.graphql = {};\n\n    // 设置 alias\n    if (this.options.alias) {\n      global[this.options.alias] = this;\n    }\n    else {\n      global.framework = this;\n    }\n\n    global.logger = console;\n    global.logger.trace = global.logger.log;\n    global.logger.debug = global.logger.log;\n  }\n\n  use(middlewareName) {\n    let middleware;\n    if (isString(middlewareName)) {\n      // TODO: 等待 import 支持 动态导入后取出 require;\n      try {\n        /* eslint-disable global-require */\n        /* eslint-disable import/no-dynamic-require */\n        middleware = require(`ofa2-${middlewareName}`);\n      }\n      catch (e) {\n        // eslint-disable-next-line no-console\n        console.warn(e);\n        process.exit(1);\n      }\n    }\n    else {\n      middleware = middlewareName;\n    }\n\n    this.middlewares.push(middleware.default ? middleware.default : middleware);\n    return this;\n  }\n\n  async [SymbolCheckMiddleware](name) {\n    await Promise.each(this.middlewares, (middleware) => {\n      if (isFunction(middleware[name])) {\n        return middleware[name].call(this);\n      }\n      return undefined;\n    });\n\n    this.emit(`${name}ed`);\n  }\n\n  async [symbolLift]() {\n    await Promise.each(this.middlewares, (middleware) => {\n      if (isFunction(middleware)) {\n        return middleware.call(this);\n      }\n      if (isFunction(middleware.lift)) {\n        return middleware.lift.call(this);\n      }\n      return undefined;\n    });\n\n    this.emit('lifted');\n  }\n\n  lift() {\n    this.promise = this.promise\n      .then(() => {\n        return this[symbolLift]();\n      })\n      .catch((e) => {\n        this.logger.warn(e);\n        process.exit(1);\n      });\n    return this;\n  }\n\n  listen() {\n    this.promise = this.promise.then(() => {\n      return this[SymbolCheckMiddleware]('listen');\n    });\n    return this;\n  }\n\n  lower() {\n    this.promise = this.promise.then(() => {\n      return this[SymbolCheckMiddleware]('lower');\n    });\n    return this;\n  }\n}\n\nexport default Ofa2;\n"],"names":["symbolLift","Symbol","SymbolCheckMiddleware","process","on","err","error","exit","reason","p","log","Ofa2","EventEmitter","projectPath","options","middlewares","Error","init","environment","env","NODE_ENV","trim","promise","Promise","resolve","config","model","global","graphql","alias","framework","logger","console","trace","debug","middlewareName","middleware","isString","require","e","warn","push","default","name","each","isFunction","call","undefined","emit","lift","then","catch"],"mappings":"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"}